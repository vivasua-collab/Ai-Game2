# Checkpoint 28: Система инвентаря и экипировки

**Дата начала:** 2025-02-28
**Статус:** В разработке

---

## 📋 Общее описание

Реализация полноценной системы инвентаря с:
- Экипировкой на персонаже (отображается на кукле)
- Инвентарём 7x7 (размер зависит от рюкзака)
- Духовным хранилищем (кольцо хранения)
- Drag & Drop механикой

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    ИГРОВОЙ ИНТЕРФЕЙС (Phaser)                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   ЭКИПИРОВКА    │    │    ИНВЕНТАРЬ    │                    │
│  │   (на кукле)    │◄──►│   (7x7 сетка)   │                    │
│  └─────────────────┘    └─────────────────┘                    │
│                              │                                  │
│                              │ Клавиша "I" открывает инвентарь │
│                              ▼                                  │
│                   ┌─────────────────────┐                      │
│                   │   InventoryScene    │                      │
│                   │   (Phaser Scene)    │                      │
│                   └─────────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 Слоты экипировки

| Слот | ID | Типы предметов |
|------|-----|----------------|
| Голова | `head` | helmet, hat, crown |
| Торс | `torso` | armor, robe, clothes |
| Левая рука | `left_hand` | weapon, shield, ring |
| Правая рука | `right_hand` | weapon, tool, ring |
| Ноги | `legs` | pants, greaves |
| Ступни | `feet` | boots, shoes |
| Аксессуар 1 | `accessory1` | ring, amulet, talisman |
| Аксессуар 2 | `accessory2` | ring, amulet, talisman |
| Спина | `back` | cloak, wings, cape |
| Рюкзак | `backpack` | bag, backpack (определяет размер инвентаря) |

---

## ✅ Этапы реализации

### Этап 1: База данных и типы
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 1.1 Создать типы в `src/types/inventory.ts`
- [x] 1.2 Обновить Prisma схему
- [x] 1.3 Создать `src/services/inventory.service.ts`

**Отчёт:**
```
[2025-02-28] Этап 1 завершён

Созданные файлы:
- src/types/inventory.ts (400+ строк)
- prisma/schema.prisma (обновлён до v8)
- src/services/inventory.service.ts (680+ строк)

База данных:
- Миграция применена успешно
- Новые таблицы созданы
```

---

### Этап 2: Phaser Inventory Scene
**Статус:** ✅ Завершён
**Оценка:** 2-3 дня

- [x] 2.1 Создать InventorySceneConfig внутри PhaserGame.tsx
- [x] 2.2 Добавить обработку клавиши "I" для запуска InventoryScene
- [x] 2.3 InventoryScene работает как overlay поверх GameScene
- [x] 2.4 Закрытие по ESC или повторному нажатию I

**Отчёт:**
```
[2025-02-28] Этап 2 завершён

Создано:
- InventorySceneConfig (250+ строк) внутри PhaserGame.tsx
  * Полупрозрачный фон overlay
  * Панель инвентаря 700x450px
  * Кукла тела (SVG на canvas)
  * 6 слотов экипировки
  * Сетка инвентаря 7x7
  * Демо-предметы с редкостью
  * Tooltip при наведении
  * Закрытие по I/ESC/крестику

Изменения в GameSceneConfig:
- Клавиша "I" запускает/останавливает InventoryScene
- ESC закрывает InventoryScene

Изменения в PhaserGame React:
- Убран useState для inventoryOpen/inventoryTab
- Убран InventoryDialog из рендера
- Инвентарь теперь полностью на Phaser canvas
```

---

### Этап 3: Drag & Drop система
**Статус:** ✅ Завершён
**Оценка:** 1-2 дня

- [x] 3.1 Реализовать drag для предметов
- [x] 3.2 Создать drop zones для экипировки
- [x] 3.3 Создать drop zones для инвентаря
- [x] 3.4 Логика перемещения между слотами
- [x] 3.5 Визуальный feedback при перетаскивании
- [x] 3.6 Проверка совместимости (тип предмета → слот)

**Отчёт:**
```
[2025-02-28] Этап 3 завершён

API маршруты:
- /api/inventory/equip - экипировка/снятие
- /api/inventory/move - перемещение предметов
- /api/inventory/storage - духовное хранилище
- /api/inventory/state - полное состояние

Хук:
- src/hooks/useInventory.ts
```

---

### Этап 4: Духовное хранилище
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 4.1 Создать StoragePanel компонент
- [x] 4.2 Реализовать сетку хранилища
- [x] 4.3 Drag & Drop между инвентарём и хранилищем
- [x] 4.4 Зависимость размера от культивации
- [x] 4.5 Ограничение: только инвентарь ↔ хранилище

---

### Этап 5: Интеграция с игрой
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 5.1 Клавиша "I" для инвентаря (внутри Phaser)
- [x] 5.2 Закрытие по ESC
- [x] 5.3 Синхронизация с базой данных
- [x] 5.4 Сохранение состояния при выходе
- [x] 5.5 Уменьшена высота куклы в InventoryDialog

**Отчёт:**
```
[2025-02-28] Этап 5 завершён

Изменения:
- Клавиша "I" открывает InventoryScene внутри Phaser
- ESC закрывает InventoryScene
- Кукла тела уменьшена до 180px высоты
- Экипировка поднята выше
```

---

### Этап 6: UI и полировка
**Статус:** 🔄 В работе
**Оценка:** 1 день

- [x] 6.1 Кукла тела из частей с изображениями
- [x] 6.2 HP бары на каждой части тела
- [x] 6.3 Слоты экипировки поверх частей тела
- [x] 6.4 Цветовая индикация статуса частей
- [ ] 6.5 Анимации открытия/закрытия
- [ ] 6.6 Звуковые эффекты
- [ ] 6.7 Контекстное меню (использовать, выбросить)
- [ ] 6.8 Drag & Drop экипировки

**Отчёт:**
```
[2025-02-28] Этап 6 в работе

Реализовано:
- Схематичная кукла тела (геометрические фигуры)
- HP бары на каждой части (функциональный + структурный)
- Слоты экипировки позиционированы вокруг куклы
- Цветовая индикация статуса (healthy/damaged/crippled/etc)
- Легенда HP баров внизу панели куклы
- 8 слотов экипировки: head, torso, left_hand, right_hand, legs, feet, accessory1, accessory2
```

---

## 📊 Прогресс

| Этап | Статус | Прогресс |
|------|--------|----------|
| 1. База данных и типы | ✅ Завершён | 100% |
| 2. Phaser Inventory Scene | ✅ Завершён | 100% |
| 3. Drag & Drop | ✅ Завершён | 100% |
| 4. Духовное хранилище | ✅ Завершён | 100% |
| 5. Интеграция | ✅ Завершён | 100% |
| 6. UI и полировка | 🔄 В работе | 60% |

**Общий прогресс:** 93%

---

## 📝 Примечания

- **Инвентарь в Phaser**: Открывается по клавише "I" как overlay сцена
- Размер инвентаря: базовый 7x7 (49 слотов) + бонус от рюкзака
- Духовное хранилище: открывается с уровня культивации 3
- Максимальный вес: сила × 5 кг
- Стаки: расходники до 99, остальные 1
- **Кукла тела**: Схематичная (геометрические фигуры через Graphics)
- **HP частей тела**: Функциональный (красный) + структурный (серый)
- **Статусы частей**: healthy(зелёный), damaged(жёлтый), crippled(оранжевый), paralyzed(красный), critical(тёмно-красный), severed(коричневый)
- **Слоты экипировки**: 8 слотов вокруг куклы

---

## 🔄 История изменений

| Дата | Изменение |
|------|-----------|
| 2025-02-28 | Создан план реализации |
| 2025-02-28 | Этап 1 завершён - типы, Prisma, сервис |
| 2025-02-28 | Этап 2 завершён - интеграция инвентаря в Phaser |
| 2025-02-28 | Этап 3 завершён - Drag & Drop система |
| 2025-02-28 | Этап 4 завершён - Духовное хранилище |
| 2025-02-28 | Этап 5 завершён - Интеграция с игрой |
| 2025-02-28 | Инвентарь перенесён внутрь Phaser (InventoryScene) |
| 2025-02-28 | Схематичная кукла тела с HP барами |
| 2025-02-28 | Слоты экипировки вокруг куклы |
| 2025-02-28 | Цветовая индикация статуса частей тела |
