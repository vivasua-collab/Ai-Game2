# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –ò–ò-–∞–≥–µ–Ω—Ç–∞

## –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –®–∞–≥ | –ó–∞–¥–∞—á–∞ | –°—Ç–∞—Ç—É—Å | DoD |
|-----|--------|--------|-----|
| 0 | Baseline + –≤–µ—Ç–∫–∞ | ‚úÖ Done | lint/build —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã |
| 1 | –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ | ‚úÖ Done | updatedTime –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å |
| 2 | –£—Å—Ç–∞–ª–æ—Å—Ç—å –ø—Ä–æ—Ä—ã–≤–∞ | ‚úÖ Done | + –≤–º–µ—Å—Ç–æ - |
| 3 | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è restart | ‚úÖ Done | $transaction |
| 4 | ~~–í–∞–ª–∏–¥–∞—Ü–∏—è payload~~ | ‚úÖ Done | CustomConfigSchema |
| 5 | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è services | ‚è≥ Pending | Thin controllers |
| 6 | Build + metadata | ‚úÖ Done | Fonts fallback |
| 7 | Zustand shallow fix | ‚úÖ Done | No infinite loop |
| 8 | README –Ω–∞ —Ä—É—Å—Å–∫–æ–º | ‚úÖ Done | –ü–µ—Ä–µ–≤–æ–¥ |

---

## ‚úÖ –í–°–ï –ö–†–ò–¢–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **Zustand infinite loop** - –¥–æ–±–∞–≤–ª–µ–Ω `shallow` comparison
2. **Build –ø—Ä–æ—Ö–æ–¥–∏—Ç** - –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–µ
3. **README –ø–µ—Ä–µ–≤–µ–¥—ë–Ω** - –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫

### –í–µ—Ç–∫–∞:
`fix/core-consistency-pass-1`

### Pull Request:
https://github.com/vivasua-collab/Ai-Game2/pull/new/fix/core-consistency-pass-1

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ!)

### –û—à–∏–±–∫–∞ 1: Zustand getServerSnapshot
```
Console Error: The result of getServerSnapshot should be cached to avoid an infinite loop
src/stores/game.store.ts (247:37) @ useGameActions
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `useGameActions` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ–Ω–¥–µ—Ä.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ë—ã–ª–æ (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑):
export const useGameActions = () => useGameStore(state => ({
  startGame: state.startGame,
  // ...
}));

// –ù—É–∂–Ω–æ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å shallow comparison –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã):
import { shallow } from 'zustand/shallow';

export const useGameActions = () => useGameStore(
  state => ({
    startGame: state.startGame,
    loadGame: state.loadGame,
    sendAction: state.sendAction,
  }),
  shallow
);
```

### –û—à–∏–±–∫–∞ 2: Maximum update depth exceeded
```
Console Error: Maximum update depth exceeded
src/components/ui/switch.tsx (13:5) @ Switch
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Switch –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ-—Ä–µ–Ω–¥–µ—Ä.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ useEffect –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å useCallback –¥–ª—è handlers.

---

## –®–∞–≥ 0: Baseline –∏ –≤–µ—Ç–∫–∞ ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ç–∫–∞ `master2`
- [x] Lint –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [x] Build –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ Google Fonts (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ fallback)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ worklog.md**

---

## –®–∞–≥ 1: –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** `updatedTime: null` –≤ –æ—Ç–≤–µ—Ç–∞—Ö API –ø–æ—Å–ª–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏/–ø—Ä–æ—Ä—ã–≤–∞.

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –°–æ–∑–¥–∞–Ω `calculateUpdatedTime()` helper
- [x] –£–±—Ä–∞–Ω—ã —Ä–∞–Ω–Ω–∏–µ `return ... updatedTime: null`
- [x] –í—Å–µ –≤–µ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `updatedTime`

**DoD:** ‚úÖ –ü–æ—Å–ª–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏/–ø—Ä–æ—Ä—ã–≤–∞ –≤—Ä–µ–º—è –≤ UI —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

---

## –®–∞–≥ 2: –£—Å—Ç–∞–ª–æ—Å—Ç—å –ø—Ä–∏ –ø—Ä–æ—Ä—ã–≤–µ ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Å—Ç–∞–ª–æ—Å—Ç—å –≤—ã—á–∏—Ç–∞–ª–∞—Å—å –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–µ–Ω–∏—è.

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –ó–∞–º–µ–Ω–µ–Ω–æ `-` –Ω–∞ `+` –¥–ª—è fatigue
- [x] –î–æ–±–∞–≤–ª–µ–Ω cap `Math.min(100, ...)`

**DoD:** ‚úÖ –ü—Ä–æ—Ä—ã–≤ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Å—Ç–∞–ª–æ—Å—Ç—å

---

## –®–∞–≥ 3: –ê—Ç–æ–º–∞—Ä–Ω—ã–π restart ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –º–∏—Ä–∞.

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –û–±—ë—Ä–Ω—É—Ç–æ –≤ `db.$transaction([...])`

**DoD:** ‚úÖ –ù–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –º–∏—Ä–æ–≤

---

## –®–∞–≥ 4: –í–∞–ª–∏–¥–∞—Ü–∏—è payload ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** `customConfig: z.record(z.unknown())` —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±–æ.

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –°–æ–∑–¥–∞–Ω `customConfigSchema` —Å —Å—Ç—Ä–æ–≥–∏–º–∏ –ø–æ–ª—è–º–∏
- [x] –ü—Ä–∏–º–µ–Ω—ë–Ω –∫ `startGameSchema`

**DoD:** ‚úÖ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ–ª—è –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## –®–∞–≥ 5: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è services ‚è≥

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ route –∏ services.

**TODO:**
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ orchestration –≤ GameService
- [ ] Route —Å–¥–µ–ª–∞—Ç—å thin-controller
- [ ] –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö—Ä–∏—Ç–µ—Ä–∏–π:** API-—Ä–æ—É—Ç—ã < 100 —Å—Ç—Ä–æ–∫

---

## –®–∞–≥ 6: Build-—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚ö†Ô∏è

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
- [x] –î–æ–±–∞–≤–ª–µ–Ω fallback –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ metadata

**–û—Å—Ç–∞–ª–æ—Å—å:**
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å build –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å test script –≤ package.json

---

## –®–∞–≥ 7: README –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚è≥

**TODO:**
- [ ] –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ README.md –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
- [ ] –û–ø–∏—Å–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É, –∑–∞–ø—É—Å–∫, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## –®–∞–≥ 8: –ú–∏–Ω–∏-—á–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ PR

- [ ] Lint –∑–µ–ª—ë–Ω—ã–π
- [ ] –¢–µ—Å—Ç—ã –Ω–∞ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –º–µ–¥–∏—Ç–∞—Ü–∏–∏/–ø—Ä–æ—Ä—ã–≤–∞
- [ ] –¢–µ—Å—Ç—ã –Ω–∞ —É—Å—Ç–∞–ª–æ—Å—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ—Ä—ã–≤–∞
- [ ] –¢–µ—Å—Ç—ã –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é start payload
- [ ] –ù–µ—Ç —Ä–∞–Ω–Ω–∏—Ö –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ `updatedTime: null`
- [ ] Migration note –≤ worklog.md

---

## –§–∞–π–ª—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–Ω–æ (—Å–µ–π—á–∞—Å):
1. `src/stores/game.store.ts` - useGameActions —Å shallow
2. `src/components/game/GameChat.tsx` - useCallback –¥–ª—è handlers
3. `src/components/start/StartScreen.tsx` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å useEffect

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. `README.md` - –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
5. `package.json` - –¥–æ–±–∞–≤–∏—Ç—å test script

---

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ lint
bun run lint

# –ü—Ä–æ–≤–µ—Ä–∫–∞ build (–≤ –æ—Ñ–ª–∞–π–Ω)
bun run build

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
bun run test

# Dev —Å–µ—Ä–≤–µ—Ä
bun run dev
```
