# Checkpoint 28: Система инвентаря и экипировки

**Дата начала:** 2025-02-28
**Статус:** В разработке

---

## 📋 Общее описание

Реализация полноценной системы инвентаря с:
- Экипировкой на персонаже (отображается на кукле)
- Инвентарём 7x7 (размер зависит от рюкзака)
- Духовным хранилищем (в той же вкладке, список)
- Drag & Drop механикой

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    ИНВЕНТАРЬ (React + Phaser)                    │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                     REACT InventoryDialog                   │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │ │
│  │  │  Кукла тела  │  │  7x7 сетка   │  │   Хранилище      │  │ │
│  │  │  (+слоты)    │  │  инвентаря   │  │   (список)       │  │ │
│  │  │  Масштаб 20% │  │              │  │   ↓ клик         │  │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              │ API: /api/inventory/state         │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   PHASER InventoryScene                     │ │
│  │  - Открывается по клавише "I"                               │ │
│  │  - Overlay поверх GameScene                                 │ │
│  │  - Синхронизация с React через Event Bus                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 Слоты экипировки

| Слот | ID | Типы предметов |
|------|-----|----------------|
| Голова | `head` | helmet, hat, crown |
| Торс | `torso` | armor, robe, clothes |
| Левая рука | `left_hand` | weapon, shield, ring |
| Правая рука | `right_hand` | weapon, tool, ring |
| Ноги | `legs` | pants, greaves |
| Ступни | `feet` | boots, shoes |
| Аксессуар 1 | `accessory1` | ring, amulet, talisman |
| Аксессуар 2 | `accessory2` | ring, amulet, talisman |
| Спина | `back` | cloak, wings, cape |
| Рюкзак | `backpack` | bag, backpack (определяет размер инвентаря) |

---

## ✅ Этапы реализации

### Этап 1: База данных и типы
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 1.1 Создать типы в `src/types/inventory.ts`
- [x] 1.2 Обновить Prisma схему (v8)
- [x] 1.3 Создать `src/services/inventory.service.ts`

**Отчёт:**
```
[2025-02-28] Этап 1 завершён

Созданные файлы:
- src/types/inventory.ts (400+ строк)
- prisma/schema.prisma (обновлён до v8)
- src/services/inventory.service.ts (700+ строк)

Таблицы БД:
- InventoryItem (предметы)
- Equipment (экипировка)
- SpiritStorage (хранилище)
```

---

### Этап 2: React InventoryDialog
**Статус:** ✅ Завершён
**Оценка:** 2 дня

- [x] 2.1 Создать InventoryDialog компонент
- [x] 2.2 Реализовать BodyDoll (кукла тела)
- [x] 2.3 Создать InventoryGrid (7x7 сетка)
- [x] 2.4 Создать StoragePanel (хранилище-список)
- [x] 2.5 Drag & Drop между всеми зонами

**Отчёт:**
```
[2025-02-28] Этап 2 завершён

Компоненты:
- InventoryDialog.tsx - главный диалог
- BodyDoll.tsx - SVG кукла тела
- InventoryGrid.tsx - сетка инвентаря
- StoragePanel.tsx - хранилище (список!)

Особенности:
- Хранилище в той же вкладке (не отдельные табы)
- Предметы в хранилище = только название и уровень
- Клик = перемещение в инвентарь
```

---

### Этап 3: API маршруты
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 3.1 `/api/inventory` - список предметов
- [x] 3.2 `/api/inventory/state` - полное состояние
- [x] 3.3 `/api/inventory/equip` - экипировка
- [x] 3.4 `/api/inventory/move` - перемещение
- [x] 3.5 `/api/inventory/storage` - хранилище
- [x] 3.6 `/api/inventory/use` - использование
- [x] 3.7 `/api/inventory/add-qi-stone` - добавление камней Ци

---

### Этап 4: Phaser Inventory Scene
**Статус:** ✅ Завершён
**Оценка:** 2 дня

- [x] 4.1 InventorySceneConfig внутри PhaserGame.tsx
- [x] 4.2 Клавиша "I" для открытия/закрытия
- [x] 4.3 ESC закрывает инвентарь
- [x] 4.4 Overlay поверх GameScene
- [x] 4.5 Демо-предметы с редкостью

---

### Этап 5: Камни Ци (Qi Stones)
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 5.1 Создать `src/types/qi-stones.ts`
- [x] 5.2 6 типов камней по документации
- [x] 5.3 Минимальная Ци = 1000, шаг *10, макс = 100M
- [x] 5.4 API для добавления камней

**Отчёт:**
```
[2025-02-28] Этап 5 завершён

Камни Ци (по документации qi_stone.md):
- Осколок: 1,000 Ци (common)
- Фрагмент: 10,000 Ци (uncommon)
- Камень: 100,000 Ци (rare)
- Кристалл: 1,000,000 Ци (epic)
- Сердце: 10,000,000 Ци (legendary)
- Ядро: 100,000,000 Ци (mythic)

Плотность: 1024 Ци/см³
```

---

### Этап 6: UI полировка
**Статус:** ✅ Завершён
**Оценка:** 1 день

- [x] 6.1 Кукла тела масштаб +20%
- [x] 6.2 HP бары на частях тела
- [x] 6.3 Цветовая индикация статусов
- [x] 6.4 Хранилище как список в той же вкладке
- [ ] 6.5 Анимации открытия/закрытия
- [ ] 6.6 Контекстное меню (использовать, выбросить)

---

### Этап 7: Синхронизация React ↔ Phaser
**Статус:** 🔄 В работе
**Оценка:** 2 дня

- [x] 7.1 Обновление инвентаря каждые 10 секунд
- [x] 7.2 Event Bus инфраструктура
- [ ] 7.3 Прозрачная двусторонняя связь ячеек
- [ ] 7.4 Маркирование multi-slot предметов

---

## 📊 Прогресс

| Этап | Статус | Прогресс |
|------|--------|----------|
| 1. База данных и типы | ✅ Завершён | 100% |
| 2. React InventoryDialog | ✅ Завершён | 100% |
| 3. API маршруты | ✅ Завершён | 100% |
| 4. Phaser Inventory Scene | ✅ Завершён | 100% |
| 5. Камни Ци | ✅ Завершён | 100% |
| 6. UI полировка | ✅ Завершён | 80% |
| 7. Синхронизация | 🔄 В работе | 30% |

**Общий прогресс:** 87%

---

## 📝 Примечания

### Размеры
- **Инвентарь**: базовый 7x7 (49 слотов) + бонус от рюкзака
- **Кукла тела**: 216x384px (увеличена на 20%)
- **Хранилище**: открывается с уровня культивации 3

### Вес и стаки
- **Максимальный вес**: сила × 5 кг
- **Стаки**: расходники до 99, остальные 1
- **Камни Ци**: стакаются по типу

### Статусы частей тела
- healthy (зелёный)
- damaged (жёлтый)
- crippled (оранжевый)
- paralyzed (красный)
- critical (тёмно-красный)
- severed (коричневый)

---

## 🔧 Известные проблемы и решения

| Проблема | Причина | Решение | Статус |
|----------|---------|---------|--------|
| "Failed to fetch inventory state" | NULL в обязательных полях БД | `bun run db:push --force-reset` | ✅ Исправлено |
| Предметы не отображаются | characterId не передан | Проверить store.character?.id | ✅ Проверено |
| Drag & Drop в Phaser | Не реализован полностью | Этап 7.4 | 📅 Запланировано |

---

## 🔄 История изменений

| Дата | Изменение |
|------|-----------|
| 2025-02-28 | Создан план реализации |
| 2025-02-28 | Этапы 1-4 завершены |
| 2025-02-28 | Инвентарь перенесён внутрь Phaser |
| 2025-02-28 | Схематичная кукла тела с HP барами |
| 2025-02-28 | Цветовая индикация статуса частей |
| 2025-02-28 | Камни Ци по документации (1000-100M) |
| 2025-02-28 | Кукла тела масштаб +20% |
| 2025-02-28 | Хранилище как список в той же вкладке |
| 2025-02-28 | Исправлена ошибка NULL в БД (force-reset) |
| 2025-02-28 | Push в ветку main2d2 |
| 2025-03-01 | **Восстановлены файлы Event Bus из ветки mani2d3** |
| 2025-03-01 | Меню: "Игра" → "Меню игры", "Настройки" → "Создание" |
| 2025-03-01 | **Исправлена ошибка камней Ци - Prisma orderBy location не поддерживается** |
| 2025-03-01 | Добавлена интеграция камней Ци с TruthSystem |

---

## 📚 Связанная документация

- [qi_stone.md](./docs/qi_stone.md) - Камни Ци (физика, размеры, типы)
- [equip.md](./docs/equip.md) - Система экипировки
- [body.md](./docs/body.md) - Система тела
- [checkpoint28-sub.md](./checkpoint28-sub.md) - Event Bus
