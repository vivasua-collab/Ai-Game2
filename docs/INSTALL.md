# 📦 Установка и запуск Cultivation World Simulator

> Полное руководство по установке, настройке и запуску проекта.
> Последнее обновление: 2026-02-28

---

## 📋 Системные требования

| Компонент | Минимум | Рекомендуется |
|-----------|---------|---------------|
| **Bun** | 1.0+ | 1.1+ |
| **Node.js** | 18+ | 20+ (если не используется Bun) |
| **RAM** | 4 GB | 8 GB |
| **Диск** | 500 MB | 1 GB |
| **ОС** | Linux, macOS, Windows (WSL2) | Linux, macOS |

---

## 🚀 Быстрый старт

### 1. Клонирование проекта

```bash
git clone https://github.com/vivasua-collab/Ai-Game2.git
cd Ai-Game2
git checkout main2D
```

### 2. Установка зависимостей

```bash
bun install
```

### 3. Инициализация базы данных

```bash
bun run db:generate
bun run db:push
```

### 4. Запуск

```bash
bun run dev
```

Игра автоматически откроется в 2D режиме!

---

## 🎮 Первый запуск

При первом запуске:

1. **Автоматически создаётся персонаж** — имя "Путник", вариант старта "Секта"
2. **Сессия сохраняется** — ID записывается в localStorage
3. **LLM генерирует историю** — уникальное вступление

При последующих запусках:
- Сессия восстанавливается из localStorage автоматически

---

## 📁 Структура проекта

```
Ai-Game2/
├── src/
│   ├── app/
│   │   ├── api/              # API эндпоинты
│   │   │   ├── game/         # start, state, move
│   │   │   ├── rest/         # медитация, отдых, сон
│   │   │   ├── technique/    # использование техник
│   │   │   └── chat/         # чат с LLM
│   │   ├── page.tsx          # Главная страница (автозапуск)
│   │   └── layout.tsx        # Корневой layout
│   │
│   ├── components/
│   │   ├── game/             # Игровые компоненты
│   │   │   ├── PhaserGame.tsx      # 2D игра
│   │   │   ├── ChatPanel.tsx       # Чат + статус
│   │   │   ├── RestDialog.tsx      # Единый диалог отдыха
│   │   │   ├── StatusDialog.tsx    # Статус персонажа
│   │   │   ├── TechniquesDialog.tsx # Техники
│   │   │   └── ActionButtons.tsx   # Кнопки действий
│   │   └── ui/               # shadcn/ui компоненты
│   │
│   ├── data/
│   │   └── presets/          # Унифицированные пресеты
│   │       ├── base-preset.ts      # Базовый интерфейс
│   │       ├── technique-presets.ts # Техники (13 шт)
│   │       ├── skill-presets.ts    # Навыки (9 шт)
│   │       ├── formation-presets.ts # Формации (8 шт)
│   │       ├── item-presets.ts     # Предметы (15 шт)
│   │       ├── character-presets.ts # Персонажи (6 шт)
│   │       └── index.ts            # Единый экспорт
│   │
│   ├── lib/
│   │   ├── game/             # Игровая логика
│   │   │   ├── constants.ts        # Константы игры
│   │   │   ├── qi-system.ts        # Медитация, прорыв
│   │   │   ├── qi-shared.ts        # Расчёты Ци
│   │   │   ├── fatigue-system.ts   # Усталость
│   │   │   ├── time-system.ts      # Система времени
│   │   │   └── ...
│   │   ├── llm/              # LLM интеграция
│   │   └── db.ts             # Prisma клиент
│   │
│   ├── services/             # Сервисный слой
│   ├── stores/               # Zustand хранилища
│   │   └── game.store.ts     # Глобальное состояние
│   └── types/                # TypeScript типы
│
├── game/                     # Phaser 3 сцены
│   ├── config/               # Конфигурация игры
│   └── scenes/               # Сцены Phaser
│
├── prisma/
│   └── schema.prisma         # Схема БД
│
├── db/
│   └── custom.db             # SQLite база
│
├── docs/                     # Документация
├── .env                      # Переменные окружения
└── README.md
```

---

## 🛠️ Доступные скрипты

| Скрипт | Описание |
|--------|----------|
| `bun run dev` | Запуск сервера разработки (порт 3000) |
| `bun run build` | Сборка для продакшена |
| `bun start` | Запуск продакшен сервера |
| `bun run lint` | Проверка ESLint |
| `bun run db:push` | Применить схему Prisma к БД |
| `bun run db:generate` | Генерация Prisma клиента |

---

## ⚙️ Конфигурация

### Переменные окружения (.env)

```env
# База данных
DATABASE_URL="file:./db/custom.db"

# LLM (опционально)
LLM_PROVIDER="z-ai"
```

### Настройка LLM

Проект поддерживает провайдеры:
1. **z-ai** (по умолчанию) — через SDK
2. **local** — Ollama
3. **api** — кастомный API

---

## 🎮 Управление в игре

| Клавиша | Действие |
|---------|----------|
| `W` / `↑` | Движение вверх |
| `S` / `↓` | Движение вниз |
| `A` / `←` | Движение влево |
| `D` / `→` | Движение вправо |

### UI элементы

| Кнопка | Описание |
|--------|----------|
| 📊 Статус | Полный статус персонажа (4 вкладки) |
| ⏸️ Отдых/Медитация | Единый диалог с 3 вкладками |
| ⚔️ Техники | Просмотр и использование техник |
| 🎒 Инвентарь | В разработке |
| 🗺️ Карта | В разработке |

---

## 🗄️ База данных

### Схема (версия 6)

- **Character** — персонажи с культивацией
- **CharacterTechnique** — изученные техники с мастерством
- **Technique** — шаблоны техник
- **Location** — локации (3D координаты)
- **NPC** — неигровые персонажи
- **Sect** — секты
- **GameSession** — игровые сессии
- **InventoryItem** — предметы инвентаря
- **SystemLog** — системные логи

### Сброс БД

```bash
rm -f db/custom.db
bun run db:push
```

---

## 🐛 Устранение неполадок

### Ошибка: "Cannot find module"

```bash
rm -rf node_modules
bun install
```

### Ошибка: "Database is locked"

```bash
pkill -f "next"
bun run db:push
bun run dev
```

### Порт 3000 занят

```bash
lsof -i :3000
kill -9 <PID>
```

### Phaser не загружается

- Проверьте консоль браузера
- Phaser загружается динамически (требуется интернет для первого запуска)

---

## 📱 Режимы запуска

### Разработка

```bash
bun run dev
```
- Горячая перезагрузка
- Подробные ошибки
- DevTools

### Продакшен

```bash
bun run build
bun start
```
- Оптимизированная сборка
- Минимум логов

---

## 🔄 Обновление проекта

```bash
git fetch origin
git pull origin main2D
bun install
bun run db:push
```

---

## 📞 Поддержка

При проблемах:

1. Проверьте версию Bun: `bun --version`
2. Проверьте .env файл
3. Проверьте логи в консоли
4. Сбросьте БД и попробуйте снова

---

*Документация актуальна на 2026-02-28. Версия схемы БД: 6*
