// Prisma schema for Cultivation World Simulator
// Version: 6
// v1: Базовая схема
// v2: Добавлена система логирования (SystemLog)
// v3: Добавлены поля worldId, worldName, startType в GameSession; name в Character
// v4: Добавлены навыки культивации, система обучения техникам, 3D координаты, система усталости
// v5: Расширена модель InventoryItem (isConsumable, durability, qiCharge, effects, icon)
// v6: Добавлены модели Building и WorldObject для системы карты

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== GAME SESSION ====================

model GameSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация мира ===
  worldId     String @default(cuid()) // Уникальный ID мира
  worldName   String @default("Неизвестный мир") // Название мира
  
  // Стартовый вариант (1=секта, 2=случайный, 3=кастомный)
  startVariant Int     @default(1)
  startType    String  @default("sect") // sect, random, custom - текстовый тип
  
  // Мировое время
  worldYear   Int @default(1864)  // Год по Э.С.М.
  worldMonth  Int @default(1)     // Месяц (1-12)
  worldDay    Int @default(1)     // День (1-30)
  worldHour   Int @default(6)     // Час (0-23)
  worldMinute Int @default(0)     // Минута (0-59)
  
  // Время от попадания ГГ
  daysSinceStart Int @default(0)
  
  // Текущее состояние мира (JSON string)
  worldState String @default("{}")
  
  // Статус симуляции
  isPaused Boolean @default(true)
  
  // Связи
  character Character  @relation(fields: [characterId], references: [id], onDelete: Cascade)
  characterId String
  messages   Message[]
  events     WorldEvent[]
  npcs       NPC[]
  locations  Location[]
  sects      Sect[]
}

// ==================== CHARACTER ====================

model Character {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация ===
  name String @default("Безымянный") // Имя персонажа
  
  // === Базовые характеристики ===
  // Все характеристики с точностью 0.01
  strength     Float @default(10.0)  // Сила
  agility      Float @default(10.0)  // Ловкость
  intelligence Float @default(10.0)  // Интеллект (IQ)
  conductivity Float @default(0.0)   // Проводимость меридиан (ед/сек)
  
  // === Культивация ===
  cultivationLevel    Int @default(1)  // Основной уровень (1-9)
  cultivationSubLevel Int @default(0)  // Под-уровень (0-9)
  
  // === Ядро ===
  coreCapacity  Int   @default(1000) // Ёмкость ядра (ед)
  coreQuality   Float @default(1.0)  // Качество ядра
  currentQi     Int   @default(0)    // Текущее количество Ци
  accumulatedQi Int   @default(0)    // Накопленная для прорыва Ци
  
  // === Физиология ===
  health        Float @default(100.0) // Здоровье (%)
  fatigue       Float @default(0.0)   // Физическая усталость (%)
  mentalFatigue Float @default(0.0)   // Ментальная усталость (%)
  age           Int   @default(16)    // Возраст (лет)
  
  // === Память и система ===
  hasAmnesia       Boolean @default(true)  // Амнезия
  knowsAboutSystem Boolean @default(false) // Знает о системе
  
  // === Позиция ===
  currentLocationId String?
  currentLocation   Location? @relation("CurrentLocation", fields: [currentLocationId], references: [id])
  
  // === Принадлежность ===
  sectId   String?
  sect     Sect?   @relation(fields: [sectId], references: [id])
  sectRole String? // candidate, outer_disciple, inner_disciple, core_member, elder
  
  // === Ресурсы ===
  contributionPoints Int @default(0) // Очки вклада (ОВ)
  spiritStones       Int @default(0) // Духовные камни
  
  // === Навыки культивации (JSON: {"skill_id": level}) ===
  cultivationSkills String @default("{}")
  
  // === Понимание Ци (аккумулятор прозрения) ===
  qiUnderstanding    Int @default(0)    // Текущее значение
  qiUnderstandingCap Int @default(100)  // Максимум (растёт с уровнем)
  
  // === Множитель восстановления усталости ===
  fatigueRecoveryMultiplier Float @default(1.0)
  
  // Связи
  sessions   GameSession[]
  inventory  InventoryItem[]
  techniques CharacterTechnique[]
  techniquePools TechniquePool[]
}

// ==================== MESSAGE ====================

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Тип сообщения
  type String // narration, system, player, command, overlord
  
  // Отправитель
  sender String? // narrator, system, player, overlord
  
  // Контент
  content String
  
  // Метаданные (JSON string)
  metadata String?
}

// ==================== WORLD EVENT ====================

model WorldEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Тип события
  eventType String // qi_change, breakthrough, battle, discovery, etc.
  
  // Описание
  description String
  
  // Влияние на мир (JSON string)
  worldImpact String?
  
  // Обработано ли
  processed Boolean @default(false)
}

// ==================== NPC ====================

model NPC {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // === Базовые данные ===
  name  String
  title String?
  age   Int
  
  // === Культивация ===
  cultivationLevel    Int
  cultivationSubLevel Int
  coreCapacity        Int
  currentQi           Int
  
  // === Характеристики ===
  strength     Float
  agility      Float
  intelligence Float
  conductivity Float
  
  // === Личность ===
  personality String    // Черты характера (JSON)
  motivation  String? // Мотивация
  
  // === Отношения ===
  disposition Float @default(0) // Отношение к ГГ (-100 до 100)
  
  // === Принадлежность ===
  sectId String?
  sect   Sect?   @relation(fields: [sectId], references: [id])
  role   String? // elder, disciple, candidate, etc.
  
  // === Позиция ===
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])
}

// ==================== LOCATION ====================

model Location {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // === Базовые данные ===
  name        String
  description String?
  
  // === Координаты (3D: метры от центра мира) ===
  x Int @default(0)  // Восток(+)/Запад(-)
  y Int @default(0)  // Север(+)/Юг(-)
  z Int @default(0)  // Высота(+)/Глубина(-)
  distanceFromCenter Int @default(50000) // Вычисляемое расстояние
  
  // === Характеристики места ===
  qiDensity  Int @default(100) // ед/м³
  qiFlowRate Int @default(10)  // ед/сек (для лей-линий)
  
  // === Тип местности ===
  terrainType String @default("plains") // mountains, plains, forest, sea, desert, etc.
  
  // === Тип локации ===
  locationType String @default("area") // region, area, building, room
  
  // === Размеры (для регионов) ===
  width  Int? // Размер области в метрах (x)
  height Int? // Размер области в метрах (y)
  
  // === Связи ===
  characters     Character[]  @relation("CurrentLocation")
  npcs           NPC[]
  subLocations   Location[]   @relation("SubLocations")
  parentLocation Location?    @relation("SubLocations", fields: [parentLocationId], references: [id])
  parentLocationId String?
  sects          Sect[]
  buildings      Building[]
  objects        WorldObject[]
  rooms          Location[]   @relation("BuildingRooms")
  buildingParent Location?    @relation("BuildingRooms", fields: [buildingParentId], references: [id])
  buildingParentId String?
}

// ==================== SECT ====================

model Sect {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // === Базовые данные ===
  name        String
  description String?
  
  // === Расположение ===
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  
  // === Уровень силы секты ===
  powerLevel Float @default(5.0) // Средний уровень культивации старейшин
  
  // === Ресурсы секты (JSON string) ===
  resources String?
  
  // === Связи ===
  members   Character[]
  npcs      NPC[]
  buildings Building[]
}

// ==================== INVENTORY ====================

model InventoryItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  // === Данные предмета ===
  name        String
  nameId      String?     // Для поиска пресета
  description String?     // Описание
  type        String      // material, artifact, consumable, equipment, spirit_stone
  rarity      String?     // common, uncommon, rare, legendary
  icon        String?     // Эмодзи или путь к иконке

  // === Количество ===
  quantity Int @default(1)

  // === Тип использования ===
  isConsumable Boolean  @default(false) // Расходуемый?
  useAction    String?                  // Действие при использовании (heal, restore_qi, buff, etc.)

  // === Прочность (для экипировки) ===
  durability    Int?    // Текущая прочность
  maxDurability Int?    // Максимальная прочность

  // === Заряд Ци (для артефактов) ===
  qiCharge    Int?    // Текущий заряд
  maxQiCharge Int?    // Максимальный заряд

  // === Эффекты (JSON) ===
  effects String? // Эффекты при использовании: { qiRestore: 100, healthRestore: 50 }

  // === Свойства (JSON string) ===
  properties String? // Дополнительные свойства
}

// ==================== TECHNIQUES ====================

// Каталог техник (глобальный)
model Technique {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация ===
  name        String @unique
  nameId      String @unique // Для поиска дубликатов
  description String
  
  // === Классификация ===
  type     String  // combat, cultivation, support, movement, sensory, healing
  element  String  // fire, water, earth, air, void, neutral
  rarity   String  // common, uncommon, rare, legendary
  level    Int     @default(1) // Текущий уровень техники (1-9)
  
  // === Развитие техники ===
  minLevel     Int @default(1) // Минимальный уровень техники
  maxLevel     Int @default(9) // Максимальный уровень развития (не все можно развить до 9)
  canEvolve    Boolean @default(true) // Можно ли развивать технику
  
  // === Требования ===
  minCultivationLevel Int     @default(1)
  qiCost              Int     @default(0)
  physicalFatigueCost Float   @default(0)
  mentalFatigueCost   Float   @default(0)
  
  // === Требования к характеристикам (JSON) ===
  statRequirements String? // { strength, agility, intelligence, conductivity }
  
  // === Масштабирование (JSON) ===
  statScaling String? // { strength, agility, intelligence, conductivity }
  
  // === Эффекты (JSON) ===
  effects String? // { damage, healing, qiRegen, duration, statModifiers }
  
  // === Источник ===
  source String @default("created") // preset, npc, scroll, insight, created
  
  // Связи
  characterTechniques CharacterTechnique[]
}

// Изученные персонажем техники
model CharacterTechnique {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  techniqueId String
  technique   Technique @relation(fields: [techniqueId], references: [id])
  
  // === Мастерство ===
  mastery Float @default(0.0) // 0-100%
  
  // === Слот быстрого доступа ===
  quickSlot Int? // 0 = культивация, 1-12 = боевой слот, null = не назначен
  
  // === Прогресс изучения ===
  learningProgress Float @default(0.0)   // 0-100%
  learningSource  String @default("")   // preset, npc, scroll, insight
  learningStartedAt DateTime?            // Когда начали изучать
  
  @@unique([characterId, techniqueId])
}

// ==================== SETTINGS ====================

model GameSettings {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === LLM настройки ===
  llmProvider String  @default("z-ai") // z-ai, local, api
  llmModel    String?
  llmEndpoint String?
  llmApiKey   String?
  
  // === Общие настройки ===
  temperature Float @default(0.8)
  maxTokens   Int   @default(2000)
  
  // === Настройки игры ===
  autoSave    Boolean @default(true)
  autoSaveInterval Int @default(5) // минуты
  
  // === Настройки отображения ===
  showQiDensity   Boolean @default(true)
  showTimeOfDay   Boolean @default(true)
  showDistance    Boolean @default(true)
  
  // === Изображения ===
  enableImages    Boolean @default(false)
  imageProvider   String  @default("stub") // stub, local, api
}

// ==================== SYSTEM LOGS ====================

model SystemLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  // === Уровень лога ===
  level     String   // ERROR, WARN, INFO, DEBUG
  
  // === Категория ===
  category  String   // SYSTEM, API, LLM, GAME, DATABASE, UI, AUTH, UNKNOWN
  
  // === Сообщение ===
  message   String
  
  // === Детали (JSON string) ===
  details   String?
  
  // === Связи ===
  sessionId String?  // ID игровой сессии (если применимо)
  
  // === Stack trace (для ошибок) ===
  stack     String?
  
  // === Длительность операции (мс) ===
  duration  Int?
  
  // Индекс для быстрого поиска
  @@index([level])
  @@index([category])
  @@index([createdAt])
}

// ==================== TECHNIQUE POOL ====================

// Пул сгенерированных техник для выбора игроком
model TechniquePool {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === Привязка к персонажу ===
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  // === Параметры генерации ===
  targetLevel Int      // Уровень техник в пуле (обычно = уровень культивации)
  triggerType String   // breakthrough, insight, scroll, npc - источник генерации
  isConsumed  Boolean  @default(false) // Пул выбран/исчерпан

  // === Связи ===
  techniques TechniquePoolItem[]

  @@index([characterId])
  @@index([targetLevel])
}

// Техника в пуле
model TechniquePoolItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // === Привязка к пулу ===
  poolId String
  pool   TechniquePool @relation(fields: [poolId], references: [id], onDelete: Cascade)

  // === Данные техники (JSON) ===
  techniqueData String // Полный JSON техники

  // === Статус ===
  isSelected  Boolean @default(false) // Игрок выбрал эту технику
  isRevealed  Boolean @default(false) // Игрок видел описание

  // === Связь с изученной техникой (после выбора) ===
  learnedTechniqueId String?

  @@index([poolId])
}

// ==================== ENCOUNTERED ENTITIES ====================

// Встреченные персонажи и монстры
model EncounteredEntity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация ===
  name  String
  type  String  // npc, monster, animal, spirit
  title String?
  description String?
  
  // === Характеристики ===
  cultivationLevel    Int?
  cultivationSubLevel Int?
  power               Float? // Для монстров
  
  // === Отношения ===
  disposition Float @default(0) // -100 до 100
  importance  String @default("normal") // minor, normal, important, critical
  
  // === Память ===
  encounterCount    Int      @default(1)
  firstEncounter    DateTime @default(now())
  lastEncounter     DateTime @default(now())
  
  // === Местоположение ===
  lastLocationId String?
  homeLocationId String?
  
  // === Теги и данные (JSON) ===
  tags       String  @default("[]")
  customData String?
  
  // === Связь с сессией ===
  sessionId String?
  
  // Связи
  memories EntityMemory[]
  
  // Индексы
  @@index([type])
  @@index([importance])
  @@index([lastEncounter])
}

// Воспоминания о сущности
model EntityMemory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  entityId String
  entity   EncounteredEntity @relation(fields: [entityId], references: [id], onDelete: Cascade)
  
  // === Данные воспоминания ===
  type    String  // dialogue, combat, trade, quest, social
  summary String
  impact  Float   // Влияние на disposition
  
  @@index([entityId])
}

// ==================== BUILDING ====================

model Building {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация ===
  name        String
  nameId      String?   // Для поиска
  description String?
  buildingType String  @default("house") // house, shop, temple, cave, tower, sect_hq
  
  // === Координаты ===
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  // === Размеры ===
  width  Int @default(10)  // Ширина (x) в метрах
  length Int @default(10)  // Длина (y) в метрах
  height Int @default(3)   // Высота (z) в метрах
  
  // === Свойства ===
  isEnterable Boolean @default(true)
  isOwned     Boolean @default(false)
  ownerType   String? // player, npc, sect
  ownerId     String?
  
  // === Бонусы ===
  qiBonus Int @default(0)    // Бонус к медитации (%)
  comfort Int @default(0)    // Комфорт (восстановление)
  defense Int @default(0)    // Защита
  
  // === Связи ===
  sectId String?
  sect   Sect?   @relation(fields: [sectId], references: [id])
  
  @@index([buildingType])
  @@index([locationId])
}

// ==================== WORLD OBJECT ====================

model WorldObject {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // === Идентификация ===
  name        String
  nameId      String?
  description String?
  objectType  String  // resource, container, interactable, decoration
  
  // === Координаты ===
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: Cascade)
  x          Int       @default(0)
  y          Int       @default(0)
  z          Int       @default(0)
  
  // === Свойства ===
  isInteractable Boolean @default(true)
  isCollectible  Boolean @default(false)
  isDestructible Boolean @default(true)
  
  // === Состояние ===
  health     Int @default(100)
  maxHealth  Int @default(100)
  durability Int @default(100)
  
  // === Ресурсы ===
  resourceType  String? // herb, ore, wood, water
  resourceCount Int     @default(1)
  respawnTime   Int     @default(0) // в минутах
  
  // === Контейнер ===
  inventory String? // JSON с предметами
  
  // === Визуал ===
  icon String? // Эмодзи или путь
  
  @@index([objectType])
  @@index([locationId])
}
