# 📊 Комплексный анализ хранения данных

**Версия:** 1.0  
**Создано:** 2026-02-28  
**Статус:** Архитектурный документ

---

## 📋 Содержание

1. [Анализ перехода на JSON-файлы](#1-анализ-перехода-на-json-файлы)
2. [Лимиты JSON файлов](#2-лимиты-json-файлов)
3. [Расчёт размера хранения](#3-расчёт-размера-хранения)
4. [Итоговые рекомендации](#4-итоговые-рекомендации)

---

# 1. АНАЛИЗ ПЕРЕХОДА НА JSON-ФАЙЛЫ

## 1.1 Постановка вопроса

Возможно ли полностью отказаться от SQLite/Prisma и использовать только JSON-файлы?

## 1.2 Классификация моделей

```
ДИНАМИЧЕСКИЕ (часто меняются):
─────────────────────────────────────────────────────────
├── GameSession     — активная сессия, время, состояние
├── Character       — Ци, здоровье, усталость, позиция
├── Message         — история чата (растёт)
├── WorldEvent      — события мира
├── InventoryItem   — изменение количества, прочности
├── CharacterTechnique — мастерство, прогресс
├── TechniquePool   — временные пулы генерации
├── EncounteredEntity — встречи, отношения
├── EntityMemory    — воспоминания
├── WorldObject     — состояние объектов
└── SystemLog       — логи (растёт)

ПОЛУ-СТАТИЧЕСКИЕ (редко меняются):
─────────────────────────────────────────────────────────
├── Location        — базовые данные места
├── Sect            — секты
├── Building        — здания
├── NPC             — состояние (но не структура)
└── Technique       — каталог (пополняется редко)

СТАТИЧЕСКИЕ (практически не меняются):
─────────────────────────────────────────────────────────
├── GameSettings    — настройки игры
└── Пресеты         — техники, предметы, шаблоны
```

## 1.3 Статистика использования

```
Операция                    Частота         Требования
──────────────────────────────────────────────────────────────
Чтение персонажа            ~10/сек         Быстрый доступ
Запись персонажа (Ци/HP)    ~1/сек          Атомарность
Добавление сообщения        ~0.1/сек        Аппенд
Поиск NPC в локации         ~1/сек          Индекс
Поиск техник игрока         ~0.5/сек        Связь
Сохранение состояния        ~1/мин          Надёжность
──────────────────────────────────────────────────────────────
```

## 1.4 Сравнение подходов

### SQLite (текущий)

```
✅ ПРЕИМУЩЕСТВА:
─────────────────────────────────────────────────────────
+ ACID транзакции (атомарность, согласованность)
+ Индексы для быстрого поиска
+ Foreign keys для целостности связей
+ SQL для сложных запросов
+ Одновременный доступ (блокировки)
+ Автоматическое управление памятью
+ Готовые инструменты (Prisma ORM)
─────────────────────────────────────────────────────────

❌ НЕДОСТАТКИ:
─────────────────────────────────────────────────────────
- Накладные расходы на запросы
- Миграции при изменении схемы
- Файл БД растёт (фрагментация)
- Сложнее бэкапы (binary)
─────────────────────────────────────────────────────────

Производительность:
- SELECT по ID: ~1-5 мс
- SELECT с JOIN: ~5-20 мс
- INSERT/UPDATE: ~2-10 мс
- Память: ~20-100 MB
```

### JSON-файлы

```
✅ ПРЕИМУЩЕСТВА:
─────────────────────────────────────────────────────────
+ Простота (читаемый формат)
+ Версионирование через Git
+ Простой бэкап (копия файлов)
+ Нет миграций (структура гибкая)
+ Быстрое чтение всего файла
+ Легко редактировать вручную
─────────────────────────────────────────────────────────

❌ НЕДОСТАТКИ:
─────────────────────────────────────────────────────────
- НЕТ транзакций (риск потери данных)
- НЕТ индексов (поиск = перебор)
- НЕТ foreign keys (целостность вручную)
- Конкурентный доступ = проблемы
- Запись = перезапись всего файла
- Рост файла = замедление
─────────────────────────────────────────────────────────

Производительность:
- Чтение файла: ~1-50 мс (зависит от размера)
- Поиск в памяти: O(n) или O(1) с Map
- Запись: ~5-100 мс (перезапись файла)
- Память: ~10-50 MB
```

## 1.5 Архитектура JSON-хранилища

### Структура директорий

```
/data/
├── sessions/
│   ├── active.json           # ID активной сессии
│   └── session_{id}/
│       ├── meta.json         # GameSession данные
│       ├── world/
│       │   ├── time.json     # Мировое время
│       │   ├── state.json    # Состояние мира
│       │   └── events.json   # История событий
│       ├── character/
│       │   ├── main.json     # Персонаж игрока
│       │   ├── inventory.json
│       │   ├── techniques.json
│       │   └── pools.json
│       ├── world_data/
│       │   ├── locations.json
│       │   ├── npcs.json
│       │   ├── sects.json
│       │   └── buildings.json
│       └── history/
│           ├── messages.json
│           └── logs.json
│
├── presets/
│   ├── techniques/
│   │   ├── index.json
│   │   └── level-{1-9}.json
│   ├── items/
│   │   ├── index.json
│   │   └── level-{1-9}.json
│   └── npc-templates.json
│
└── settings.json
```

---

# 2. ЛИМИТЫ JSON ФАЙЛОВ

## 2.1 Размер одного объекта техники

```
Средний размер одной техники (сгенерированной):
─────────────────────────────────────────────────────
Базовые поля (id, name, type, level...)    ~150 байт
Модификаторы (effects, bonuses...)         ~100 байт
Вычисляемые значения (computed)             ~50 байт
Метаданные (meta)                           ~80 байт
─────────────────────────────────────────────────────
ИТОГО на 1 технику:                        ~380 байт

При 20,000 техник:
20,000 × 380 байт ≈ 7.6 MB

С форматированием (отступы):               ~12-15 MB
Без форматирования (минимум):              ~7-8 MB
```

## 2.2 Время загрузки

```
Количество объектов    Время чтения    Время парсинга    Итого
────────────────────────────────────────────────────────────────
1,000                  5 мс            10 мс             15 мс
5,000                  25 мс           50 мс             75 мс
10,000                 50 мс           100 мс            150 мс
20,000                 100 мс          200 мс            300 мс
50,000                 250 мс          500 мс            750 мс
100,000                500 мс          1 сек            1.5 сек
```

## 2.3 Потребление памяти

```
Количество объектов    Размер JSON    В памяти (V8)    Накладные
────────────────────────────────────────────────────────────────
1,000                  380 KB         1.5 MB           +300%
10,000                 3.8 MB         15 MB            +300%
20,000                 7.6 MB         30 MB            +300%
50,000                 19 MB          75 MB            +300%
100,000                38 MB          150 MB           +300%
```

## 2.4 Рекомендуемые лимиты

```
РЕКОМЕНДУЕМЫЕ ЛИМИТЫ:
────────────────────────────────────────────────────────
Макс. объектов в одном файле:     10,000
Макс. размер файла:               5 MB
Макс. общий размер всех файлов:   50 MB
────────────────────────────────────────────────────────

ЖЁСТКИЕ ЛИМИТЫ:
────────────────────────────────────────────────────────
Макс. объектов в одном файле:     20,000
Макс. размер файла:               10 MB
────────────────────────────────────────────────────────
```

## 2.5 Стратегия разбиения файлов

```
Уровень    Техник    Файл                    Размер
────────────────────────────────────────────────────────
1          1024      level-1.json            ~400 KB
2          512       level-2.json            ~200 KB
3          256       level-3.json            ~100 KB
...        ...       ...                     ...
────────────────────────────────────────────────────────
ИТОГО      2046      9 файлов                ~650 KB
```

**При добавочной генерации:**

```
Если количество техник уровня 1 > 10,000:
→ level-1_part1.json  (10,000)
→ level-1_part2.json  (остаток)
```

## 2.6 Сравнение с другими форматами

| Формат | Размер | Скорость парсинга | Читаемость |
|--------|--------|-------------------|------------|
| JSON | 100% | Базовая | ✅ Отличная |
| JSON (мин.) | 60% | +10% быстрее | ❌ Плохая |
| MessagePack | 40% | +50% быстрее | ❌ Бинарный |
| SQLite | 70% | +30% быстрее | ❌ Бинарный |

**Рекомендация:** JSON остаётся оптимальным выбором для пресетов из-за:
- Читаемости и редактируемости
- Простоты отладки
- Версионирования через Git

---

# 3. РАСЧЁТ РАЗМЕРА ХРАНЕНИЯ

## 3.1 Ограничения системы

- **Максимум 100 игровых персонажей** — хранение в полном объёме
- **NPC/Монстры** — соотношение 1:1000 (до 100,000 на 100 игроков)
- **Техники NPC** — только ID, без развития (прокачки)
- **Количество техник** — ограничено активными слотами на уровне

### Слоты техник по уровню:

```
Формула: 3 + (level - 1) боевых слотов + 1 слот культивации

Уровень  Боевые  Культивация  Всего
─────────────────────────────────────
   1       3         1          4
   2       4         1          5
   3       5         1          6
   4       6         1          7
   5       7         1          8
   6       8         1          9
   7       9         1         10
   8      10         1         11
   9      11         1         12
```

## 3.2 Структура Character (полная)

```
Character (текущая схема Prisma):
─────────────────────────────────────────────────────────
id                    String    25 байт
createdAt             DateTime  8 байт
updatedAt             DateTime  8 байт
name                  String    15 байт
strength              Float     8 байт
agility               Float     8 байт
intelligence          Float     8 байт
conductivity          Float     8 байт
cultivationLevel      Int       4 байта
cultivationSubLevel   Int       4 байта
coreCapacity          Int       4 байта
coreQuality           Float     8 байт
currentQi             Int       4 байта
accumulatedQi         Int       4 байта
health                Float     8 байт
fatigue               Float     8 байт
mentalFatigue         Float     8 байт
age                   Int       4 байта
hasAmnesia            Boolean   1 байт
knowsAboutSystem      Boolean   1 байт
currentLocationId     String?   25 байт
sectId                String?   25 байт
sectRole              String?   15 байт
contributionPoints    Int       4 байта
spiritStones          Int       4 байта
cultivationSkills     String    200 байт (JSON)
qiUnderstanding       Int       4 байта
qiUnderstandingCap    Int       4 байта
conductivityMeditations Int     4 байта
fatigueRecoveryMultiplier Float 8 байт
─────────────────────────────────────────────────────────
ИТОГО базовый Character:           ~470 байт
```

## 3.3 Расчёт на одного игрока (уровень 9)

```
Компонент                    Количество    Размер
──────────────────────────────────────────────────────
Character (базовый)          1             470 байт
GameSession                  1             700 байт
Location (текущая)           1             400 байт
──────────────────────────────────────────────────────
Базовый персонаж                           1,570 байт
──────────────────────────────────────────────────────
Technique (каталог)          12            10,200 байт
  (общий каталог, делится)
CharacterTechnique           12            1,560 байт
──────────────────────────────────────────────────────
Техники                                    11,760 байт
──────────────────────────────────────────────────────
InventoryItem                50            35,000 байт
  (полный инвентарь + equip)
──────────────────────────────────────────────────────
Инвентарь                                  35,000 байт
──────────────────────────────────────────────────────
ИТОГО на 1 игрока:           ~48 KB
```

## 3.4 Расчёт на 100 игроков

```
Компонент                    Размер
──────────────────────────────────────────────────────
Characters (100 × 1.5 KB)              157 KB
GameSessions (100 × 0.7 KB)            70 KB
Locations (100 × 0.4 KB)               40 KB
──────────────────────────────────────────────────────
База игроков                           267 KB
──────────────────────────────────────────────────────
Техники (каталог, ~200 уникальных)     170 KB
CharacterTechniques (100 × 12 × 130)   156 KB
──────────────────────────────────────────────────────
Техники игроков                        326 KB
──────────────────────────────────────────────────────
InventoryItems (100 × 50 × 700)        3,500 KB
──────────────────────────────────────────────────────
Инвентарь игроков                      3,500 KB
──────────────────────────────────────────────────────
ИТОГО 100 игроков:                     ~4.1 MB
```

## 3.5 NPC и монстры (хранение по ID)

### Структура NPC (упрощённая)

```typescript
interface NPCMinimal {
  // === ИДЕНТИФИКАЦИЯ ===
  id: string;                  // 25 байт
  name: string;                // 15 байт
  type: 'npc' | 'monster' | 'spirit'; // 10 байт
  
  // === ПОЗИЦИЯ ===
  locationId: string;          // 25 байт
  
  // === УРОВЕНЬ (для генерации) ===
  cultivationLevel: number;    // 4 байта
  
  // === ШАБЛОН (ключевой ID) ===
  templateId: string;          // 25 байт
  variant?: string;            // 10 байт
  
  // === СОСТОЯНИЕ ===
  currentQi: number;           // 4 байта
  health: number;              // 4 байта
  disposition: number;         // 4 байта (отношение к игроку)
  
  // === ТЕХНИКИ (только ID) ===
  techniqueIds: string[];      // 12 × 25 = 300 байт (макс)
  
  // === ЭКИПИРОВКА (только ID) ===
  equipmentIds: string[];      // 10 × 25 = 250 байт (макс)
}

// ИТОГО NPC Minimal: ~700 байт
```

### Сравнение структур NPC

```
Подход                         Размер       Экономия
─────────────────────────────────────────────────────
Полный NPC (Character-подобный)  ~2000 байт   0%
Минималистичный (с ID)           ~700 байт    65%
Только ID + seed                 ~150 байт    92%
─────────────────────────────────────────────────────
```

### Расчёт на 100,000 NPC

```
Подход                    Количество    Размер         Итого
──────────────────────────────────────────────────────────────
Минималистичный (рекоменд.)
  NPC Minimal             100,000       700 байт      70 MB
  
Только ID + seed
  NPC Ultra-Minimal       100,000       150 байт      15 MB
──────────────────────────────────────────────────────────────
```

## 3.6 Каталог пресетов (общий для NPC)

```
Техники-пресеты (заранее сгенерированные):
─────────────────────────────────────────────────────────
Количество: ~200 базовых техник
Размер: 200 × 850 = 170 KB

Предметы-пресеты:
─────────────────────────────────────────────────────────
Количество: ~300 базовых предметов
Размер: 300 × 700 = 210 KB

Шаблоны NPC:
─────────────────────────────────────────────────────────
Количество: ~50 шаблонов (воин, маг, монстр, торговец...)
Размер: 50 × 2000 = 100 KB
─────────────────────────────────────────────────────────
ИТОГО каталог пресетов:           ~480 KB
```

## 3.7 Итоговая оценка базы данных

```
┌─────────────────────────────────────────────────────────────┐
│                     БАЗА ДАННЫХ                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  КАТАЛОГ ПРЕСЕТОВ (~480 KB)                          │    │
│  │  ├── PresetTechnique (200 шт)                        │    │
│  │  ├── PresetItem (300 шт)                             │    │
│  │  └── NpcTemplate (50 шт)                             │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ИГРОВЫЕ ПЕРСОНАЖИ (~4.1 MB)                         │    │
│  │  ├── Character (100 шт) - полное хранение            │    │
│  │  ├── GameSession (100 шт)                            │    │
│  │  ├── Technique (каталог, ~200 шт)                    │    │
│  │  ├── CharacterTechnique (1200 шт)                    │    │
│  │  └── InventoryItem (5000 шт)                         │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  NPC И МОНСТРЫ (15-70 MB)                            │    │
│  │  └── NPC Minimal (100,000 шт)                        │    │
│  │      ├── ID + позиция + состояние                    │    │
│  │      ├── techniqueIds[] (только ID)                  │    │
│  │      └── equipmentIds[] (только ID)                  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  МИР (локации, события, секты)                       │    │
│  │  ├── Location (~1000 шт)                             │    │
│  │  ├── WorldEvent (история)                            │    │
│  │  └── Sect (секты)                                    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Итоговый размер

```
Компонент                      Размер          Примечание
──────────────────────────────────────────────────────────────
КАТАЛОГ ПРЕСЕТОВ
  PresetTechnique (200)        170 KB
  PresetItem (300)             210 KB
  NpcTemplate (50)             100 KB
──────────────────────────────────────────────────────────────
  Итого каталоги:              480 KB

ИГРОВЫЕ ПЕРСОНАЖИ (100)
  Character + Session + Loc    267 KB
  Техники (каталог + связи)    326 KB
  InventoryItem (5000)         3,500 KB
──────────────────────────────────────────────────────────────
  Итого игроки:                4.1 MB

NPC И МОНСТРЫ (100,000)
  Минималистичный подход       70 MB
  Ultra-minimal (только ID)    15 MB
──────────────────────────────────────────────────────────────
  Итого NPC (рекоменд.):       15-70 MB

МИР
  Locations (1000)             400 KB
  Sects, Events, прочее        500 KB
──────────────────────────────────────────────────────────────
  Итого мир:                   900 KB

──────────────────────────────────────────────────────────────
ИТОГО БАЗА ДАННЫХ:             20-75 MB
  (рекомендуемый диапазон)
──────────────────────────────────────────────────────────────
```

---

# 4. ИТОГОВЫЕ РЕКОМЕНДАЦИИ

## 4.1 Гибридный вариант (рекомендуется)

```
┌─────────────────────────────────────────────────────────────┐
│  БЫСТРО МЕНЯЮЩИЕСЯ → SQLite (ACID, транзакции)              │
│  ├── Character (Ци, HP, усталость — часто)                  │
│  ├── Inventory (количество — часто)                         │
│  ├── CharacterTechnique (мастерство — иногда)               │
│  └── TechniquePool (временные)                              │
├─────────────────────────────────────────────────────────────┤
│  СТАТИЧЕСКИЕ → JSON файлы (кэш в памяти)                    │
│  ├── Пресеты техник                                         │
│  ├── Пресеты предметов                                      │
│  ├── Шаблоны NPC                                            │
│  └── Настройки игры                                         │
├─────────────────────────────────────────────────────────────┤
│  ИСТОРИЯ → JSON файлы (ротация)                             │
│  ├── Messages                                               │
│  ├── SystemLogs                                             │
│  └── WorldEvents (архив)                                    │
└─────────────────────────────────────────────────────────────┘
```

## 4.2 Установленные лимиты

```typescript
const LIMITS = {
  // Рекомендуемые
  RECOMMENDED_MAX_FILE_SIZE: 5 * 1024 * 1024,     // 5 MB
  MAX_OBJECTS_PER_FILE: 10_000,
  
  // Жёсткие
  HARD_MAX_FILE_SIZE: 10 * 1024 * 1024,           // 10 MB
  HARD_MAX_OBJECTS_PER_FILE: 20_000,
  
  // Предупреждения
  WARN_FILE_SIZE: 3 * 1024 * 1024,                // 3 MB
  WARN_OBJECTS_COUNT: 5_000,
};
```

## 4.3 Стратегия хранения

```
✅ ХРАНИТЬ ПОЛНОСТЬЮ:
─────────────────────────────────────────────────────────
- Игровые персонажи (макс. 100)
- Каталог техник игрока (созданные/изученные)
- Инвентарь игроков
- Состояния сессий
─────────────────────────────────────────────────────────

✅ ХРАНИТЬ ПО ID:
─────────────────────────────────────────────────────────
- NPC и монстры (до 100,000)
- Техники NPC (массив ID)
- Экипировка NPC (массив ID)
─────────────────────────────────────────────────────────

✅ ГЕНЕРИРОВАТЬ ЗАРАНЕЕ:
─────────────────────────────────────────────────────────
- Пресеты техник (~200 шт)
- Пресеты предметов (~300 шт)
- Шаблоны NPC (~50 шт)
─────────────────────────────────────────────────────────
```

## 4.4 Сравнение вариантов

| Критерий | SQLite | JSON | Гибрид |
|----------|--------|------|--------|
| Сложность реализации | Низкая | Средняя | Средняя |
| Атомарность | ✅ Автомат | ❌ Вручную | ✅ Частично |
| Производительность | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| Простота бэкапов | ❌ Binary | ✅ Text | ✅ Text |
| Версионирование | ❌ Миграции | ✅ Git | ✅ Git |
| Масштабируемость | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| **Рекомендация** | | | ✅ |

## 4.5 Выводы

1. **JSON работает стабильно** до 20,000 объектов в одном файле
2. **Рекомендуется разбивать** файлы при достижении 10,000 объектов
3. **Размер файла 5 MB** — оптимальный лимит
4. **Ленивая загрузка** предпочтительна для UI
5. **Кэширование в памяти** — обязательно для производительности
6. **Гибридный подход** оптимален для проекта с ≤100 игроками

---

## 📊 СВОДНАЯ ТАБЛИЦА

| Компонент | Количество | Размер |
|-----------|------------|--------|
| **Пресеты** | | |
| PresetTechnique | 200 | 170 KB |
| PresetItem | 300 | 210 KB |
| NpcTemplate | 50 | 100 KB |
| **Игроки** | | |
| Character + связи | 100 | 4.1 MB |
| **NPC** | | |
| NPC Minimal | 100,000 | 15-70 MB |
| **Мир** | | |
| Locations + прочее | ~1000 | 900 KB |
| **ИТОГО** | | **20-75 MB** |

---

*Документ создан путём объединения:*
- *json-storage-analysis.md*
- *json-file-limits.md*
- *save_size.md*
