# 🎯 Чекпоинт 29: Система конечностей и отрубания

**Версия:** 1.1 (Концепция)  
**Дата:** 2026-02-28  
**Статус:** 📝 Концептуализация  
**Последнее обновление:** Добавлены система приживления, сердце, привязка к тикам

---

## 📋 Обзор

Система повреждений конечностей в стиле Kenshi с двойной HP полоской, кровотечениями и возможностью отрубания.

### Ключевые механики

1. **Двойная HP** — красная (функциональная) + чёрная (структурная)
2. **Отрубание** — при потере структурной целостности
3. **Кровотечение** — в зависимости от типа повреждения (за ТИК)
4. **Восстановление** — в обратном порядке (чёрная → красная)
5. **Приживление** — возможность приживить чужую конечность
6. **Регенерация** — восстановление отрубленной конечности при высоком уровне культивации

### ⏱️ Понятие ТИКА

**ТИК** — базовая единица игрового времени.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          СИСТЕМА ТИКОВ                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1 ТИК = 1 минута игрового времени                                      │
│                                                                          │
│   Все временные расчёты привязаны к ТИКАМ:                               │
│   - Кровотечение: урон за тик                                            │
│   - Регенерация: HP за тик                                               │
│   - Приживление: длительность в тиках                                    │
│   - Длительность эффектов: в тиках                                       │
│                                                                          │
│   ВАЖНО: Длительность ТИКА может быть изменена!                          │
│   Все формулы используют ТИК как единицу, не секунды/минуты.             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 1️⃣ СИСТЕМА ДВОЙНОЙ HP

### 1.1 Концепция

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    HP КОНЕЧНОСТИ (Пример: Рука)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ████████████████████░░░░░░░░░░░░░░░░░░░░  Красная полоска             │
│   │←── Функциональная HP (40) ──→│         (функционирует)              │
│                                                                          │
│   ████████████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │
│   │←────────── Структурная HP (80) ──────────────→│                      │
│                                                   (целостность)          │
│                                                                          │
│   Соотношение: Структурная HP = Функциональная HP × 2                    │
│                                                                          │
│   ИСКЛЮЧЕНИЕ: Сердце имеет только красную HP!                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Типы HP

```typescript
interface LimbHP {
  // === ФУНКЦИОНАЛЬНАЯ HP (Красная) ===
  functional: {
    max: number;           // Максимальное значение
    current: number;       // Текущее значение
    color: '#ef4444';      // Красный (red-500)
    
    // Когда > 0: конечность функционирует нормально
    // Когда = 0: конечность парализована, не работает
  };
  
  // === СТРУКТУРНАЯ HP (Чёрная) ===
  structural: {
    max: number;           // = functional.max × 2 (обычно)
    current: number;       // Текущее значение
    color: '#1f2937';      // Тёмно-серый (gray-800)
    
    // Когда > 0: конечность физически прикреплена
    // Когда = 0: следующая атака отрубает конечность
  };
  
  // === ИСКЛЮЧЕНИЯ ===
  // Сердце: structural.max = 0, только functional HP
}
```

### 1.3 Соотношение HP по частям тела

| Часть тела | Функциональная | Структурная | Итого | Особенности |
|------------|----------------|-------------|-------|-------------|
| Голова | 50 | 100 | 150 | — |
| Торс | 100 | 200 | 300 | Защищает сердце (уровень 5+) |
| **Сердце** | **80** | **—** | **80** | **Только красная HP!** |
| Рука | 40 | 80 | 120 | — |
| Кисть | 20 | 40 | 60 | — |
| Нога | 50 | 100 | 150 | — |
| Стопа | 25 | 50 | 75 | — |
| Глаз | 10 | 20 | 30 | — |
| Ухо | 8 | 16 | 24 | — |
| Крыло | 35 | 70 | 105 | — |
| Хвост | 30 | 60 | 90 | — |

---

## 2️⃣ СЕРДЦЕ (Особая часть тела)

### 2.1 Механика сердца

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          СИСТЕМА СЕРДЦА                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Условия поражения сердца:                                              │
│   1. Атакующий имеет уровень культивации 5+                             │
│   2. Торс цели в "чёрной зоне" (structural < 50%)                       │
│   3. Атака — точечная, направленная в торс                              │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                        ТОРС (lvl 5+ практик)                     │   │
│   │   ████████████████████░░░░░░░░░░░░░░░░░░░░  Красная 100         │   │
│   │   ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  Чёрная 80/200       │   │
│   │                              │                                    │   │
│   │                              ▼                                    │   │
│   │   ┌──────────────────────────────────────────────┐               │   │
│   │   │  ❤️ СЕРДЦЕ (доступно для атаки)              │               │   │
│   │   │  ████████████████████░░░░░░░░░░░░░░░░░░░░░░  │ 60/80         │   │
│   │   │  Только красная HP!                           │               │   │
│   │   └──────────────────────────────────────────────┘               │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   При HP сердца = 0 → Критическое состояние / Смерть                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Структура сердца

```typescript
interface HeartProperties {
  // Сердце имеет ТОЛЬКО функциональную HP
  hp: {
    max: 80;              // Базовое HP сердца
    current: number;      // Текущее HP
    // Нет структурной HP!
  };
  
  // Доступность для атаки
  vulnerable: boolean;    // true если торс в чёрной зоне и атакующий 5+ уровня
  
  // Эффекты при повреждении
  effects: {
    below50: 'reduced_circulation';    // -50% к регенерации
    below25: 'heart_failure_risk';     // Шанс смерти каждую секунду
    at0: 'death';                       // Смерть
  };
}

function isHeartVulnerable(
  attackerLevel: number,
  torsoStructuralPercent: number
): boolean {
  // Сердце уязвимо только если:
  // 1. Атакующий 5+ уровень
  // 2. Торс в чёрной зоне (structural < 50%)
  return attackerLevel >= 5 && torsoStructuralPercent < 0.5;
}
```

### 2.3 Последствия повреждения сердца

| HP сердца | Эффект |
|-----------|--------|
| 80-50 | Норма |
| 50-25 | Сниженная циркуляция, -50% регенерации всех конечностей |
| 25-1 | Риск остановки сердца, 5% шанс смерти за тик |
| 0 | Смерть |

---

## 3️⃣ МЕХАНИКА ПОВРЕЖДЕНИЙ

### 3.1 Распределение урона

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПОРЯДОК ПРИМЕНЕНИЯ УРОНА                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1. Сначала — Функциональная HP (красная)                               │
│      Урон → functional.current -= damage                                 │
│                                                                          │
│   2. После исчерпания функциональной — Структурная HP (чёрная)          │
│      Урон → structural.current -= damage                                 │
│                                                                          │
│   3. При structural.current = 0 → Отрубание                              │
│      Следующая атака → SEVERED                                           │
│                                                                          │
│   ИСКЛЮЧЕНИЕ: Сердце — урон сразу в функциональную HP                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Состояния конечности

```typescript
type LimbStatus = 
  | 'healthy'           // functional > 80%, structural > 90%
  | 'damaged'           // functional 50-80%
  | 'crippled'          // functional 1-49%
  | 'paralyzed'         // functional = 0, structural > 0
  | 'critical'          // structural 1-30%
  | 'severed';          // Отрублена

function getLimbStatus(hp: LimbHP): LimbStatus {
  const funcPercent = hp.functional.current / hp.functional.max;
  const structPercent = hp.structural.current / hp.structural.max;
  
  if (hp.structural.current <= 0) return 'severed';
  if (funcPercent === 0) return 'paralyzed';
  if (structPercent <= 0.3) return 'critical';
  if (funcPercent <= 0.5) return 'crippled';
  if (funcPercent <= 0.8) return 'damaged';
  return 'healthy';
}
```

### 3.3 Влияние состояний

| Статус | Функциональность | Описание |
|--------|------------------|----------|
| healthy | 100% | Полная функциональность |
| damaged | 75% | Штраф -25% к эффективности |
| crippled | 30% | Минимальная функция, штраф -70% |
| paralyzed | 0% | Не работает, но прикреплена |
| critical | 0% | Парализована, готова отпасть |
| severed | — | Отрублена |

---

## 4️⃣ СИСТЕМА КРОВОТЕЧЕНИЙ

### 4.1 Типы кровотечений

```typescript
interface BleedingEffect {
  type: BleedingType;
  damagePerTick: number;     // Урон ЗА ТИК (не за секунду!)
  duration: number;          // Длительность в ТИКАХ или permanent (-1)
  source: string;            // ID повреждённой части
}

type BleedingType = 
  | 'none'              // Нет кровотечения
  | 'minor'             // Лёгкое (царапина)
  | 'moderate'          // Умеренное (глубокий порез)
  | 'severe'            // Сильное (потеря функциональной HP)
  | 'critical'          // Критическое (потеря структурной HP)
  | 'arterial';         // Артериальное (отрубание)
```

### 4.2 Кровотечение по типу повреждения (ЗА ТИК)

| Событие | Тип кровотечения | Урон/ТИК | Длительность (ТИКов) |
|---------|------------------|----------|----------------------|
| Урон < 10% max HP | none | 0 | — |
| Урон 10-30% max HP | minor | 0.5 | 30 тиков (30 мин) |
| Урон 30-60% max HP | moderate | 1.0 | 60 тиков (1 час) |
| functional = 0 | severe | 2.0 | Пока не вылечено |
| structural < 50% | critical | 3.0 | Пока не вылечено |
| Отрубание | arterial | 5.0 | Пока не вылечено |

### 4.3 Влияние культивации на кровотечение

```typescript
function getBleedingResistance(cultivationLevel: number): number {
  // Уровни культивации снижают кровотечение
  const resistances: Record<number, number> = {
    1: 0,    // 0%
    2: 0.1,  // 10%
    3: 0.2,  // 20%
    4: 0.35, // 35%
    5: 0.5,  // 50%
    6: 0.65, // 65%
    7: 0.8,  // 80%
    8: 0.9,  // 90%
    9: 1.0,  // 100% - бессмертие тела
  };
  
  return resistances[cultivationLevel] || 0;
}

// Применение:
// effectiveDamagePerTick = baseDamagePerTick × (1 - bleedingResistance)
```

### 4.4 Остановка кровотечения

| Метод | Время | Эффективность |
|-------|-------|---------------|
| Бинты (предмет) | Мгновенно | minor → moderate |
| Лечебная техника | Мгновенно | Полная остановка |
| Лекарство | 10 тиков | Полная остановка |
| Регенерация Ци | Постепенно | Снижение DPS |
| Высокая культивация | Авто | Автоматическая остановка (7+) |

---

## 5️⃣ СИСТЕМА ВОССТАНОВЛЕНИЯ

### 5.1 Порядок восстановления

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПОРЯДОК ВОССТАНОВЛЕНИЯ (обратный урону)               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   1. Сначала — Структурная HP (чёрная)                                   │
│      Срастание костей, тканей                                            │
│      Требует: еда, отдых, Ци                                             │
│                                                                          │
│   2. Потом — Функциональная HP (красная)                                 │
│      Восстановление нервов, мышц                                         │
│      Требует: упражнения, Ци                                             │
│                                                                          │
│   ═══════════════════════════════════════════════════════════════════   │
│   ОТРУБЛЕННУЮ КОНЕЧНОСТЬ МОЖНО ВОССТАНОВИТЬ:                              │
│   - Регенерация тела (практики высокого уровня + формации)               │
│   - Приживление чужой конечности (см. раздел 6)                          │
│   ═══════════════════════════════════════════════════════════════════   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Скорости восстановления (HP/ТИК)

```typescript
interface RegenerationRates {
  // Базовая регенерация (без культивации)
  base: {
    structural: number;     // HP за ТИК
    functional: number;     // HP за ТИК
  };
  
  // Модификаторы культивации
  cultivationBonus: number; // × (1 + level × 0.5)
  
  // Модификаторы состояния
  resting: number;          // × 2.0 при отдыхе
  sleeping: number;         // × 3.0 при сне
  meditation: number;       // × 1.5 при медитации + Ци
  
  // Модификаторы лечения
  medicine: number;         // × (1 + medicinePower)
  healingTechnique: number; // × (1 + techniquePower)
  formation: number;        // × (1 + formationPower) для регенерации конечностей
}

// Примеры скоростей (HP за ТИК):
const REGENERATION_RATES: RegenerationRates = {
  base: {
    structural: 0.01,  // 0.01 HP/тик = 0.6 HP/час
    functional: 0.02,  // 0.02 HP/тик = 1.2 HP/час
  },
  cultivationBonus: 0.5,
  resting: 2.0,
  sleeping: 3.0,
  meditation: 1.5,
  medicine: 2.0,
  healingTechnique: 5.0,
  formation: 3.0,      // Множитель при использовании формации
};
```

### 5.3 Формула регенерации

```typescript
function calculateRegeneration(
  limb: LimbHP,
  cultivationLevel: number,
  state: 'active' | 'resting' | 'sleeping' | 'meditation',
  modifiers: { medicine?: number; technique?: number; formation?: number }
): { structuralRegen: number; functionalRegen: number } {
  
  const rates = REGENERATION_RATES;
  
  // Базовая скорость
  let structRate = rates.base.structural;
  let funcRate = rates.base.functional;
  
  // Бонус культивации
  const cultMult = 1 + cultivationLevel * rates.cultivationBonus;
  structRate *= cultMult;
  funcRate *= cultMult;
  
  // Модификатор состояния
  const stateMult = {
    active: 1.0,
    resting: rates.resting,
    sleeping: rates.sleeping,
    meditation: rates.meditation,
  }[state];
  
  structRate *= stateMult;
  funcRate *= stateMult;
  
  // Модификаторы лечения
  if (modifiers.medicine) {
    structRate *= 1 + modifiers.medicine * rates.medicine;
    funcRate *= 1 + modifiers.medicine * rates.medicine;
  }
  
  if (modifiers.technique) {
    structRate *= 1 + modifiers.technique * rates.healingTechnique;
    funcRate *= 1 + modifiers.technique * rates.healingTechnique;
  }
  
  // Порядок восстановления: сначала structural, потом functional
  // Functional восстанавливается только если structural > 50%
  if (limb.structural.current < limb.structural.max * 0.5) {
    funcRate = 0;
  }
  
  return {
    structuralRegen: structRate,
    functionalRegen: funcRate,
  };
}
```

### 5.4 Регенерация на высоких уровнях культивации (HP/ТИК)

| Уровень | Структурная/тик | Функциональная/тик | Особенности |
|---------|-----------------|--------------------|-------------|
| 1 | 0.015 | 0.03 | Базовая |
| 3 | 0.03 | 0.06 | Ускоренное |
| 5 | 0.06 | 0.12 | Быстрое заживление |
| 7 | 0.12 | 0.24 | Очень быстрое |
| 8 | 0.24 | 0.48 | **Отрастание конечностей** |
| 9 | ∞ | ∞ | Мгновенная регенерация |

---

## 6️⃣ СИСТЕМА ПРИЖИВЛЕНИЯ КОНЕЧНОСТЕЙ

### 6.1 Концепция

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ПРИЖИВЛЕНИЕ ЧУЖОЙ КОНЕЧНОСТИ                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Возможность: Приживить конечность от другого практика                  │
│                                                                          │
│   Условия:                                                               │
│   1. Конечность не может быть от практика полным УРОВНЕМ выше            │
│   2. В рамках одного уровня — от практика на 3 СТУПЕНИ выше              │
│   3. Конечность должна быть "свежей" — не более 24 ТИКов (суток)         │
│   4. Источник: ещё живой или свежеубиенный практик                       │
│                                                                          │
│   Процесс:                                                               │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  1. Приживление → конечность в состоянии "приживается"          │   │
│   │  2. Время приживления зависит от уровня культивации             │   │
│   │  3. Если конечность от практика ниже уровнем → подтягивается     │   │
│   │  4. Если от практика выше уровнем → НЕВОЗМОЖНО приживить         │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Правила совместимости

```typescript
interface LimbCompatibility {
  canAttach: boolean;
  reason: string;
  tierDifference: number;  // Разница в ступенях
}

function checkLimbCompatibility(
  recipient: Practitioner,  // Тот, кому приживляют
  donor: Practitioner,      // Тот, от кого берут конечность
  limb: BodyPart
): LimbCompatibility {
  
  const recLevel = recipient.cultivationLevel;  // Уровень реципиента (1-9)
  const recStep = recipient.cultivationStep;     // Ступень реципиента (1-10)
  const donLevel = donor.cultivationLevel;       // Уровень донора
  const donStep = donor.cultivationStep;         // Ступень донора
  
  // Правило 1: Нельзя приживить от практика полным уровнем выше
  if (donLevel > recLevel) {
    return {
      canAttach: false,
      reason: `Конечность от практика уровнем выше (донор: ${donLevel}, реципиент: ${recLevel})`,
      tierDifference: -1
    };
  }
  
  // Правило 2: В рамках одного уровня — максимум 3 ступени выше
  if (donLevel === recLevel) {
    const stepDiff = donStep - recStep;
    if (stepDiff > 3) {
      return {
        canAttach: false,
        reason: `Донор на ${stepDiff} ступеней выше в рамках одного уровня (макс: 3)`,
        tierDifference: stepDiff
      };
    }
    return {
      canAttach: true,
      reason: stepDiff > 0 
        ? `Конечность сильнее, время адаптации: ${stepDiff * 100} тиков`
        : 'Конечность подходит',
      tierDifference: stepDiff
    };
  }
  
  // Донор ниже уровнем — можно приживить, но нужно подтягивать
  return {
    canAttach: true,
    reason: `Конечность слабее, нужна адаптация: ${recLevel - donLevel} уровней разницы`,
    tierDifference: -(recLevel - donLevel)
  };
}
```

### 6.3 Условия свежести конечности

```typescript
interface LimbFreshness {
  isFresh: boolean;
  ticksSinceSevered: number;  // ТИКов с момента отрубания
  source: 'living' | 'freshly_killed' | 'old_corpse';
}

function checkLimbFreshness(limb: SeveredLimb): LimbFreshness {
  const ticksSinceSevered = getCurrentTick() - limb.severedAtTick;
  const maxFreshTicks = 1440; // 24 часа × 60 минут = 1440 тиков
  
  return {
    isFresh: ticksSinceSevered <= maxFreshTicks && 
             (limb.source === 'living' || limb.source === 'freshly_killed'),
    ticksSinceSevered,
    source: limb.source
  };
}

// Источники конечности:
// - living: от ещё живого практика (отрублена в бою)
// - freshly_killed: от свежеубиенного (в течение 1440 тиков)
// - old_corpse: от старого трупа (не подходит)
```

### 6.4 Процесс приживления

```typescript
interface AttachmentProcess {
  limbId: string;
  startTime: number;           // ТИК начала
  duration: number;            // Длительность в ТИКАХ
  progress: number;            // 0-100%
  status: 'attaching' | 'adapting' | 'strengthening' | 'complete' | 'rejected';
  
  // Бонусы/штрафы
  efficiencyPenalty: number;   // Штраф к эффективности пока приживается
  qiDrain: number;             // Расход Ци за тик
}

function calculateAttachmentDuration(
  recipient: Practitioner,
  donor: Practitioner,
  cultivationLevel: number
): number {
  // Базовое время: 720 тиков (12 часов)
  let baseDuration = 720;
  
  // Модификаторы:
  // - Выше уровень культивации = быстрее
  baseDuration -= cultivationLevel * 50;
  
  // - Конечность сильнее = дольше адаптация
  if (donor.cultivationLevel === recipient.cultivationLevel) {
    const stepDiff = donor.cultivationStep - recipient.cultivationStep;
    if (stepDiff > 0) {
      baseDuration += stepDiff * 100; // +100 тиков за ступень
    }
  }
  
  // - Конечность слабее = нужно подтягивать
  if (donor.cultivationLevel < recipient.cultivationLevel) {
    const levelDiff = recipient.cultivationLevel - donor.cultivationLevel;
    baseDuration += levelDiff * 200; // +200 тиков за уровень разницы
  }
  
  return Math.max(100, baseDuration); // Минимум 100 тиков
}
```

### 6.5 Этапы приживления

| Этап | Длительность | Эффект |
|------|--------------|--------|
| attaching | 20% времени | Конечность присоединена, не работает, -100% эффективность |
| adapting | 40% времени | Начинает работать, -50% эффективность |
| strengthening | 40% времени | Полная функциональность, -20% эффективность |
| complete | — | Полная работоспособность |

### 6.6 Регенерация отрубленной конечности

```typescript
interface LimbRegeneration {
  // Возможность регенерации отрубленной конечности
  canRegenerate: boolean;
  
  // Требования
  requirements: {
    minCultivationLevel: 8;     // Минимум 8 уровень
    practices: string[];        // Определённые практики регенерации
    formation: string | null;   // Формация для усиления (опционально)
  };
  
  // Параметры
  duration: number;            // В ТИКАХ
  qiCost: number;              // Расход Ци за тик
}

function calculateRegenerationDuration(
  cultivationLevel: number,
  hasFormation: boolean,
  formationPower: number = 0
): number {
  // Базовое время: 10000 тиков (~7 дней)
  let duration = 10000;
  
  // Модификатор уровня (8-9)
  duration -= (cultivationLevel - 8) * 2000;
  
  // Модификатор формации
  if (hasFormation) {
    duration -= formationPower * 500;
  }
  
  return Math.max(2000, duration); // Минимум ~1.4 дня
}
```

---

## 7️⃣ ПОСЛЕДСТВИЯ ПОВРЕЖДЕНИЙ

### 7.1 Потеря функций по частям тела

| Часть тела | Паралич | Отрубание |
|------------|---------|-----------|
| Голова | Потеря сознания | Смерть |
| Торс | Смерть | Смерть |
| Сердце | Критическое состояние | Смерть |
| Рука | Нельзя использовать | Нельзя использовать, кровотечение |
| Кисть | Нельзя держать предметы | Нельзя держать предметы |
| Нога | Хромота, -50% скорость | Ползание, -90% скорость |
| Стопа | Хромота, -30% скорость | -50% скорость |
| Глаз | Слепота на один глаз | Слепота на один глаз |
| Ухо | Глухота на одно ухо | Глухота на одно ухо |

### 7.2 Каскадные эффекты

```typescript
interface BodyPartDependencies {
  parent: string | null;
  children: string[];
  
  onParalyzed: StatusEffect[];
  onSevered: StatusEffect[];
}

const BODY_DEPENDENCIES: Record<string, BodyPartDependencies> = {
  torso: {
    parent: null,
    children: ['left_arm', 'right_arm', 'left_leg', 'right_leg', 'heart'],
    onParalyzed: [
      { type: 'death' },
    ],
    onSevered: [
      { type: 'death' },
    ],
  },
  
  heart: {
    parent: 'torso',
    children: [],
    onParalyzed: [
      { type: 'reduced_regeneration', value: -50 },
      { type: 'death_risk', value: 5 }, // 5% за тик
    ],
    onSevered: [
      { type: 'death' },
    ],
  },
  
  left_arm: {
    parent: 'torso',
    children: ['left_hand'],
    onParalyzed: [
      { type: 'manipulation_penalty', value: -100, target: 'left_hand' },
    ],
    onSevered: [
      { type: 'bleeding', severity: 'critical' },
      { type: 'manipulation_disabled', target: 'left_hand' },
    ],
  },
  // ...
};
```

---

## 8️⃣ ИНТЕГРАЦИЯ С БОЕВОЙ СИСТЕМОЙ

### 8.1 Статус интеграции

> **⚠️ ВАЖНО:** Боевая система ещё не разработана окончательно.  
> Есть только ориентировочные параметры.  
> Детали боевой системы будут разрабатываться после готовности тел и оружия.

### 8.2 Принципы интеграции

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      ИНТЕГРАЦИЯ С БОЕВОЙ СИСТЕМОЙ                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   БОЕВОЙ ИНТЕРФЕЙС — НЕ ИСПОЛЬЗУЕТСЯ                                     │
│                                                                          │
│   Механики поражения частей тела:                                        │
│                                                                          │
│   1. ТЕХНИКИ:                                                            │
│      ├── Точечные техники → шанс поражения конкретной части             │
│      ├── Удар по площади → коэффициенты распределения урона             │
│      ├── Удар конусом → поражение нескольких частей                     │
│      └── Объёмные техники → поражение всех частей в зоне                │
│                                                                          │
│   2. ОРУЖИЕ:                                                             │
│      ├── Шансы попадания по конечностям (базовые)                       │
│      ├── Потом завяжем на силу и ловкость                               │
│      └── Тип оружия влияет на распределение урона                       │
│                                                                          │
│   Порядок разработки:                                                    │
│   1. Система тел ✓ (текущий этап)                                       │
│   2. Система оружия →                                                    │
│   3. Детали боевой системы →                                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.3 Распределение урона (ориентировочное)

```typescript
// Базовое распределение (случайная атака)
const BASE_HIT_CHANCE: Record<BodyPartType, number> = {
  head: 0.05,    // 5% - сложно попасть
  torso: 0.50,   // 50% - самая большая мишень
  arm: 0.15,     // 15% каждая
  hand: 0.05,    // 5% каждая
  leg: 0.20,     // 20% каждая
  foot: 0.05,    // 5% каждая
  // ...
};

// Модификаторы типов атак (ориентировочно)
const ATTACK_TARGETING: Record<AttackType, TargetingInfo> = {
  slash: {
    preferredTargets: ['arm', 'leg', 'hand'],
    bonusChance: 0.1,
  },
  pierce: {
    preferredTargets: ['torso', 'head'],
    bonusChance: 0.15,
  },
  crush: {
    preferredTargets: ['head', 'torso'],
    bonusChance: 0.1,
  },
};
```

### 8.4 Техники и поражение частей тела

```typescript
interface TechniqueTargeting {
  type: 'point' | 'area' | 'cone' | 'volume';
  
  // Точечная — конкретная часть
  pointTarget?: BodyPartType;
  pointChance: number;        // Шанс попадания
  
  // По площади — распределение
  areaDistribution?: Record<BodyPartType, number>;  // Коэффициенты
  
  // Конус — несколько частей
  coneWidth: number;          // Ширина конуса
  coneParts: number;          // Количество поражаемых частей
  
  // Объём — все в зоне
  volumeRadius: number;       // Радиус поражения
}

// Примеры:
const TECHNIQUE_TARGETING: Record<string, TechniqueTargeting> = {
  // Точечная техника — удар в сердце
  'heart_strike': {
    type: 'point',
    pointTarget: 'heart',
    pointChance: 0.6,  // 60% шанс попадания
  },
  
  // Удар по площади — круговой удар
  'circular_slash': {
    type: 'area',
    areaDistribution: {
      torso: 0.4,
      left_arm: 0.2,
      right_arm: 0.2,
      head: 0.2,
    },
  },
  
  // Конус — огненное дыхание
  'fire_breath': {
    type: 'cone',
    coneWidth: 60,     // 60 градусов
    coneParts: 3,      // До 3 частей тела
  },
};
```

---

## 9️⃣ UI ОТОБРАЖЕНИЕ

### 9.1 Визуализация HP конечностей

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         СОСТОЯНИЕ ТЕЛА                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                    ┌─────────────────┐                                  │
│                    │  ● Голова       │                                  │
│                    │  ▓▓▓▓▓▓▓▓░░░░░ │ 45/50 (functional)              │
│                    │  ▓▓▓▓▓▓▓▓▓▓▓▓▓░│ 90/100 (structural)             │
│                    └─────────────────┘                                  │
│                                                                          │
│                    ┌─────────────────┐                                  │
│                    │  ● Торс         │                                  │
│                    │  ▓▓▓▓▓▓▓▓▓▓▓▓▓░│ 95/100                          │
│                    │  ▓▓▓▓▓▓▓▓▓▓░░░░░│ 90/200 (критич. для сердца)     │
│                    │  ├─ ❤️ Сердце   │ ← Доступно для атаки!           │
│                    │  │  ▓▓▓▓▓▓▓▓░░░░│ 60/80                           │
│                    └─────────────────┘                                  │
│                                                                          │
│   ┌──────────────┐         ┌──────────────┐                            │
│   │ ● Левая рука │         │ ○ Правая рука│ ← Парализована             │
│   │ ▓▓▓▓▓▓▓▓▓▓▓░│         │ ░░░░░░░░░░░░░│                            │
│   │ ▓▓▓▓▓▓▓▓▓▓▓▓░│         │ ▓▓▓▓▓▓░░░░░░░│ ← Critical                 │
│   └──────────────┘         └──────────────┘                            │
│                                                                          │
│   ┌──────────────┐         ┌──────────────┐                            │
│   │ ✕ Левая нога │         │ ● Правая нога│                            │
│   │ ОТРУБЛЕНА    │ ← ⚠️    │ ▓▓▓▓▓▓▓▓▓▓▓▓░│                            │
│   │ 🩸 Critical  │         │ ▓▓▓▓▓▓▓▓▓▓▓▓▓░│                            │
│   └──────────────┘         └──────────────┘                            │
│                                                                          │
│   Легенда: ● healthy  ○ paralyzed  ✕ severed  🩸 bleeding              │
│            ▓▓ functional  ██ structural  ░░ empty                       │
│            ❤️ сердце (только functional)                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔟 ПЛАН РЕАЛИЗАЦИИ

### Фаза 1: Расширение типов (2-3 часа)
- [ ] Добавить `LimbHP` интерфейс
- [ ] Добавить `HeartProperties` интерфейс
- [ ] Расширить `BodyPart` интерфейс
- [ ] Добавить `LimbStatus` типы
- [ ] Создать `BleedingEffect` интерфейс
- [ ] Создать `AttachmentProcess` интерфейс

### Фаза 2: Логика повреждений (3-4 часа)
- [ ] `applyDamageToLimb()` — распределение урона
- [ ] `getLimbStatus()` — определение состояния
- [ ] `determineBleeding()` — расчёт кровотечения (за ТИК)
- [ ] `applyBleeding()` — применение кровотечения

### Фаза 3: Логика восстановления (2-3 часа)
- [ ] `calculateRegeneration()` — скорость регенерации (за ТИК)
- [ ] `regenerateLimb()` — процесс восстановления
- [ ] Интеграция с системой отдыха/сна

### Фаза 4: Система приживления (3-4 часа)
- [ ] `checkLimbCompatibility()` — проверка совместимости
- [ ] `checkLimbFreshness()` — проверка свежести
- [ ] `calculateAttachmentDuration()` — расчёт времени приживления
- [ ] `processAttachment()` — процесс приживления

### Фаза 5: Регенерация конечностей (2-3 часа)
- [ ] `canRegenerateLimb()` — проверка возможности регенерации
- [ ] `calculateRegenerationDuration()` — расчёт времени
- [ ] `processLimbRegeneration()` — процесс регенерации

### Фаза 6: UI компоненты (3-4 часа)
- [ ] Компонент отображения HP конечностей
- [ ] Индикаторы кровотечения
- [ ] Отображение состояния сердца
- [ ] Уведомления о состояниях

### Фаза 7: Тестирование (2-3 часа)
- [ ] Unit тесты для логики повреждений
- [ ] Тестирование сценариев приживления
- [ ] Тестирование регенерации
- [ ] Балансировка скоростей

---

## 1️⃣1️⃣ ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ

| Файл | Изменения |
|------|-----------|
| `src/types/game.ts` | Добавить типы LimbHP, HeartProperties, LimbStatus, BleedingEffect, AttachmentProcess |
| `src/lib/game/body-system.ts` | **НОВЫЙ** — логика повреждений и восстановления |
| `src/lib/game/bleeding-system.ts` | **НОВЫЙ** — логика кровотечений (за ТИК) |
| `src/lib/game/limb-attachment.ts` | **НОВЫЙ** — логика приживления |
| `prisma/schema.prisma` | Добавить поля для хранения состояния конечностей |
| `src/components/game/BodyStatusPanel.tsx` | **НОВЫЙ** — UI отображения тела |
| `docs/body.md` | Обновить документацию |

---

## 📚 ССЫЛКИ

- [docs/body.md](./docs/body.md) — Существующая система тела
- [docs/COMBAT_TECHNIQUES_SYSTEM.md](./docs/COMBAT_TECHNIQUES_SYSTEM.md) — Боевая система (ориентировочная)
- [docs/start_lore.md](./docs/start_lore.md) — Лор мира (уровни культивации)

---

*Документ создан: 2026-02-28*  
*Последнее обновление: 2026-02-28 — Добавлены система приживления, сердце, привязка к ТИКАМ*
